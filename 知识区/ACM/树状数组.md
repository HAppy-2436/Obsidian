# 树状数组

## 定义
树状数组（Binary Indexed Tree，简称 BIT 或 Fenwick Tree）是一种支持前缀和查询与单点修改的数据结构，时间复杂度为 O(log n)，实现简单且常用于替代线段树处理部分区间问题。

## 核心内容
**1. 基础实现（单点加、前缀和）**
```cpp
struct BIT {
    int n;
    vector<long long> bit;
    BIT(int _n): n(_n), bit(n + 1, 0) {}

    // 单点加 val
    void add(int idx, long long val) {
        for (; idx <= n; idx += idx & -idx) bit[idx] += val;
    }

    // 前缀和 [1..idx]
    long long sum(int idx) {
        long long res = 0;
        for (; idx > 0; idx -= idx & -idx) res += bit[idx];
        return res;
    }

    // 区间和 [l..r]
    long long range_sum(int l, int r) {
        return sum(r) - sum(l - 1);
    }
};
```

**2. 区间加点查（差分思想）**
```cpp
// 想要在区间 [l, r] 增加 val 并能查询单点值，使用差分+BIT
// diff[i] 表示原数组 a 的差分：a[i] = sum(diff[1..i])
struct RangeAddPointQuery {
    BIT bit;
    RangeAddPointQuery(int n): bit(n) {}
    void range_add(int l, int r, long long val) {
        bit.add(l, val);
        bit.add(r + 1, -val);
    }
    long long point_query(int idx) {
        return bit.sum(idx); // 恢复到 a[idx]
    }
};
```

**3. 区间加区间求和（双 BIT 技巧）**n
```cpp
// 使用两个 BIT：bit1 和 bit2，支持区间加以及区间求和
struct RangeAddRangeSum {
    int n;
    BIT bit1, bit2;
    RangeAddRangeSum(int _n): n(_n), bit1(_n), bit2(_n) {}

    void _add(BIT &b, int idx, long long val) { for (; idx <= n; idx += idx & -idx) b.bit[idx] += val; }
    long long _sum(BIT &b, int idx) { long long res = 0; for (; idx > 0; idx -= idx & -idx) res += b.bit[idx]; return res; }

    void range_add(int l, int r, long long val) {
        // 更新两个树
        bit1.add(l, val);
        bit1.add(r + 1, -val);
        bit2.add(l, val * (l - 1));
        bit2.add(r + 1, -val * r);
    }

    long long prefix_sum(int idx) {
        return bit1.sum(idx) * idx - bit2.sum(idx);
    }

    long long range_sum(int l, int r) {
        return prefix_sum(r) - prefix_sum(l - 1);
    }
};
```

**4. 离线和有序统计（BIT 的其他应用）**
- 倒排计数：在 O(n log n) 内统计逆序对。
- 离散化 + BIT：处理大坐标或复杂序列问题。
- 有序统计树的轻量替代：求第k小、秩查询需结合二分或分块。

## 应用场景
- 单点更新与区间查询的场合
- 区间加点查、区间加区间求和
- 逆序对计数、排名查询、离散化后的频次统计
- 需要轻量级数据结构且不想维护线段树时

## 注意事项
- BIT 下标从1开始，文档规范经常采用1-based索引。
- 注意数据类型溢出：累加和使用 long long。
- 区间操作需选对技巧（差分、双 BIT、离散化等）。
- BIT 不易直接支持区间乘法或非线性操作。
- 查询第k小需配合二分或树状数组的 kth 实现。

## 关联知识
与 [[线段树]]、[[前缀和]]、[[离散化]]、[[分治算法]] 相关。
