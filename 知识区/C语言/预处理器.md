# 预处理器

## 定义
预处理器是编译前的文本处理阶段，处理以#开头的指令（如#include、#define、#ifdef），进行文件包含、宏替换、条件编译等操作，输出处理后的源代码给编译器。

## 核心内容
**1. 文件包含**
```c
#include <stdio.h>   // 系统头文件（搜索系统路径）
#include "myheader.h" // 用户头文件（先搜索当前目录）

// 防止重复包含
#ifndef MYHEADER_H
#define MYHEADER_H
// 头文件内容
#endif
```

**2. 宏定义**
```c
#define PI 3.14159
#define MAX(a, b) ((a) > (b) ? (a) : (b))
#define SQUARE(x) ((x) * (x))

// 取消宏定义
#undef PI
```

**3. 条件编译**
```c
// #ifdef / #ifndef
#ifdef DEBUG
    printf("Debug mode\n");
#endif

#ifndef RELEASE
    printf("Not release\n");
#endif

// #if / #elif / #else
#if VERSION >= 2
    // 新版本代码
#elif VERSION == 1
    // 旧版本兼容
#else
    // 默认代码
#endif

// defined()运算符
#if defined(WIN32) || defined(_WIN32)
    // Windows平台
#elif defined(__linux__)
    // Linux平台
#elif defined(__APPLE__)
    // macOS平台
#endif
```

**4. 预定义宏**
```c
printf("File: %s\n", __FILE__);     // 当前文件名
printf("Line: %d\n", __LINE__);     // 当前行号
printf("Date: %s\n", __DATE__);     // 编译日期
printf("Time: %s\n", __TIME__);     // 编译时间
printf("Function: %s\n", __func__); // 当前函数名（C99）

// 用于调试宏
#define DEBUG_PRINT(fmt, ...) \
    printf("[%s:%d] " fmt, __FILE__, __LINE__, ##__VA_ARGS__)
```

**5. 字符串化和连接**
```c
// # 字符串化
#define STR(x) #x
STR(hello) → "hello"

// ## 连接
#define CONCAT(a, b) a##b
CONCAT(var, 123) → var123

// 应用
#define MAKE_FUNC(name) \
    void func_##name() { printf(#name "\n"); }

MAKE_FUNC(test)  // 生成 void func_test()
```

**6. #pragma指令**
```c
#pragma once  // 防止重复包含（非标准但广泛支持）

#pragma pack(1)  // 设置结构体对齐为1字节
struct Data {
    char c;
    int i;
};
#pragma pack()  // 恢复默认对齐

#pragma message("Compiling...")  // 编译时输出消息
```

**7. #error和#warning**
```c
#ifndef CONFIG_FILE
    #error "Must define CONFIG_FILE"
#endif

#ifdef DEPRECATED_FEATURE
    #warning "This feature is deprecated"
#endif
```

**8. 查看预处理结果**
```bash
gcc -E source.c -o source.i  # 生成预处理后的文件
```

## 应用场景
- 头文件保护：防止重复包含
- 跨平台编译：根据操作系统选择不同代码
- 调试开关：DEBUG模式下打印日志
- 版本控制：根据版本号启用特性
- 配置选项：通过宏控制功能开关

## 注意事项
- 预处理器不进行语法检查（纯文本替换）
- 宏定义没有类型检查（易出错）
- 条件编译的代码块不会被编译（但会占用文件大小）
- #include会增加编译时间（头文件展开）
- 过度使用条件编译会降低可读性
- #pragma非标准，移植性差

## 关联知识
与 [[宏定义]]、[[多文件编程]]、[[const关键字]] 相关。
