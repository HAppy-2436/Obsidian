# 静态变量

## 定义
static关键字用于修饰变量和函数，改变其存储类别和作用域。局部静态变量在函数调用间保持值，存储在静态存储区；静态全局变量和静态函数限制作用域在当前文件内。static是C语言实现封装和信息隐藏的重要机制，也是理解[[内存布局]]和作用域的关键。

## 核心内容
**局部静态变量**：
```c
void counter() {
    static int count = 0;  // 只初始化一次
    count++;
    printf("count = %d\n", count);
}

int main() {
    counter();  // 输出 1
    counter();  // 输出 2
    counter();  // 输出 3
    return 0;
}
```

**特点**：
- 存储在静态存储区（不是栈）
- 生命周期：程序开始到结束
- 作用域：只在函数内可见
- 只初始化一次（默认初始化为0）
- 函数调用间保持值

**静态全局变量**：
```c
// file1.c
static int globalVar = 10;  // 只在file1.c可见

void func() {
    globalVar++;  // 可访问
}

// file2.c
extern int globalVar;  // 错误！无法访问static全局变量
```

**特点**：
- 存储在静态存储区
- 生命周期：程序开始到结束
- 作用域：限制在当前源文件（编译单元）
- 实现文件级的封装

**静态函数**：
```c
// file1.c
static void helper() {  // 只在file1.c可见
    // 内部辅助函数
}

void publicFunc() {
    helper();  // 可以调用
}

// file2.c
void test() {
    helper();  // 错误！无法访问static函数
}
```

**特点**：
- 作用域：限制在当前源文件
- 避免命名冲突
- 实现信息隐藏

**static vs extern**：
```c
// file1.c
int global1 = 10;         // 外部链接，其他文件可访问
static int global2 = 20;  // 内部链接，仅当前文件

// file2.c
extern int global1;   // OK
extern int global2;   // 错误！static限制作用域
```

**存储类别对比**：
| 类别 | 关键字 | 存储位置 | 生命周期 | 作用域 | 默认值 |
|------|--------|----------|----------|--------|--------|
| 自动 | auto | 栈 | 函数内 | 局部 | 未定义 |
| 静态局部 | static | 静态区 | 全程 | 局部 | 0 |
| 全局 | 无 | 静态区 | 全程 | 全局 | 0 |
| 静态全局 | static | 静态区 | 全程 | 文件 | 0 |
| 寄存器 | register | 寄存器 | 函数内 | 局部 | 未定义 |

**应用模式**：
```c
// 1. 计数器
int getUniqueID() {
    static int id = 0;
    return ++id;
}

// 2. 单例模式
Config* getInstance() {
    static Config instance;  // 只创建一次
    return &instance;
}

// 3. 缓存
int fibonacci(int n) {
    static int cache[100] = {0};
    if (n <= 1) return n;
    if (cache[n] != 0) return cache[n];
    cache[n] = fibonacci(n-1) + fibonacci(n-2);
    return cache[n];
}
```

**内存布局**：
```
高地址
  ↑
栈（局部变量）
  |
堆（动态分配）
  |
未初始化数据段（BSS）：static int a;
  |
已初始化数据段：static int b = 10;
  |
代码段
  ↓
低地址
```

## 应用场景
函数调用间保持状态；实现计数器、ID生成器；文件级封装；单例模式；缓存/记忆化；模块内部函数。

## 注意事项
- 局部static保持值但作用域不变
- 静态全局和函数实现文件级封装
- static变量默认初始化为0
- 多线程环境下要注意线程安全

## 关联知识
与 [[内存布局]]、[[作用域]]、[[链接属性]]、[[多文件编程]]、[[单例模式]] 相关。
