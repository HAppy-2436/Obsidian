# 文件操作

## 定义
C语言通过标准库（stdio.h）提供的文件操作函数实现文件读写，包括文本文件和二进制文件。核心是FILE结构体[[指针]]和fopen、fclose、fread、fwrite、fprintf、fscanf、fgetc、fputc等函数。文件操作是程序持久化数据、日志记录、配置管理的基础，也是系统编程的重要内容。

## 核心内容
**文件指针**：
```c
FILE *fp;  // 文件指针，指向FILE结构体
```

**打开/关闭**：
```c
// 打开文件
FILE *fopen(const char *filename, const char *mode);
fp = fopen("data.txt", "r");  // 只读
if (fp == NULL) {
    perror("文件打开失败");
    return -1;
}

// 关闭文件
int fclose(FILE *fp);
fclose(fp);
```

**打开模式**：
| 模式 | 说明 | 文件不存在 |
|------|------|------------|
| "r" | 只读 | 失败 |
| "w" | 只写（清空） | 创建 |
| "a" | 追加 | 创建 |
| "r+" | 读写 | 失败 |
| "w+" | 读写（清空） | 创建 |
| "a+" | 读写（追加） | 创建 |
| "rb"/"wb" | 二进制模式 | - |

**文本文件读写**：
```c
// 1. 字符读写
int fgetc(FILE *fp);
int fputc(int c, FILE *fp);

// 2. 字符串读写
char *fgets(char *s, int size, FILE *fp);
int fputs(const char *s, FILE *fp);

// 3. 格式化读写
int fprintf(FILE *fp, const char *format, ...);
int fscanf(FILE *fp, const char *format, ...);

// 示例：逐行读取
char line[256];
while (fgets(line, sizeof(line), fp) != NULL) {
    printf("%s", line);
}
```

**二进制文件读写**：
```c
// 读
size_t fread(void *ptr, size_t size, size_t count, FILE *fp);
int arr[10];
fread(arr, sizeof(int), 10, fp);

// 写
size_t fwrite(const void *ptr, size_t size, size_t count, FILE *fp);
fwrite(arr, sizeof(int), 10, fp);

// 示例：结构体读写
struct Student stu;
fwrite(&stu, sizeof(struct Student), 1, fp);
fread(&stu, sizeof(struct Student), 1, fp);
```

**文件定位**：
```c
// 获取当前位置
long ftell(FILE *fp);

// 设置位置
int fseek(FILE *fp, long offset, int whence);
// whence: SEEK_SET(开头), SEEK_CUR(当前), SEEK_END(结尾)
fseek(fp, 0, SEEK_SET);  // 回到开头

// 回到开头
void rewind(FILE *fp);
```

**文件状态**：
```c
// 检测文件结束
int feof(FILE *fp);

// 检测错误
int ferror(FILE *fp);

// 清除错误标志
void clearerr(FILE *fp);

// 刷新缓冲区
int fflush(FILE *fp);
```

**完整示例**：
```c
// 写文件
FILE *fp = fopen("data.txt", "w");
if (fp != NULL) {
    fprintf(fp, "Name: %s\n", "张三");
    fprintf(fp, "Age: %d\n", 20);
    fclose(fp);
}

// 读文件
fp = fopen("data.txt", "r");
if (fp != NULL) {
    char name[50];
    int age;
    fscanf(fp, "Name: %s\n", name);
    fscanf(fp, "Age: %d\n", &age);
    fclose(fp);
}
```

## 应用场景
数据持久化；日志记录；配置文件读写；数据导入导出；图像视频处理；数据库文件；二进制协议。

## 注意事项
- 打开文件后必须关闭
- 检查fopen返回值（NULL表示失败）
- 文本模式vs二进制模式
- 及时fflush刷新缓冲区

## 关联知识
与 [[指针]]、[[字符串]]、[[结构体]]、[[动态内存分配]]、[[错误处理]] 相关。
