# 宏定义

## 定义
宏定义使用`#define`指令进行文本替换，在编译预处理阶段展开。宏可定义常量、简单函数、代码片段。宏没有类型检查，不占用内存，替换发生在编译前。宏是C语言的[[预处理器]]功能之一，合理使用可提高代码可维护性和性能，但滥用会导致难以调试的问题。

## 核心内容
**定义常量**：
```c
#define PI 3.14159
#define MAX_SIZE 100
#define MSG "Hello"

// 使用
double area = PI * r * r;
int arr[MAX_SIZE];
```

**宏函数**：
```c
// 简单宏函数
#define SQUARE(x) ((x) * (x))  // 注意括号！
#define MAX(a,b) ((a) > (b) ? (a) : (b))
#define ABS(x) ((x) < 0 ? -(x) : (x))

// 使用
int result = SQUARE(5);  // 展开为 ((5) * (5))
```

**括号的重要性**：
```c
// 错误：没有括号
#define SQUARE(x) x * x
int a = SQUARE(2 + 3);  // 展开为 2 + 3 * 2 + 3 = 11（错误！）

// 正确：完整括号
#define SQUARE(x) ((x) * (x))
int a = SQUARE(2 + 3);  // 展开为 ((2+3) * (2+3)) = 25
```

**副作用问题**：
```c
#define SQUARE(x) ((x) * (x))
int a = 5;
int b = SQUARE(a++);  // 展开为 ((a++) * (a++))
// a被自增两次！结果不确定
```

**多行宏**：
```c
#define SWAP(a, b, type) do { \
    type temp = a;            \
    a = b;                    \
    b = temp;                 \
} while(0)

// 使用
SWAP(x, y, int);
```

**字符串化和连接**：
```c
// # 字符串化
#define STR(x) #x
printf(STR(hello));  // 输出 "hello"

// ## 连接
#define CONCAT(a, b) a##b
int CONCAT(var, 123) = 10;  // 定义 var123 = 10
```

**条件编译**：
```c
#define DEBUG

#ifdef DEBUG
    printf("Debug info\n");
#endif

#ifndef HEADER_H
#define HEADER_H
// 头文件内容
#endif
```

**预定义宏**：
```c
__FILE__    // 当前文件名
__LINE__    // 当前行号
__DATE__    // 编译日期
__TIME__    // 编译时间
__FUNCTION__  // 当前函数名

// 调试宏
#define DEBUG_LOG printf("[%s:%d] ", __FILE__, __LINE__)
```

**取消宏**：
```c
#undef MAX_SIZE
```

**宏vs函数**：
| 特性 | 宏 | 函数 |
|------|-----|------|
| 处理时机 | 预处理 | 运行时 |
| 类型检查 | 无 | 有 |
| 调试 | 困难 | 容易 |
| 代码大小 | 展开，可能变大 | 不变 |
| 性能 | 无调用开销 | 有调用开销 |

**最佳实践**：
1. 宏名全大写
2. 参数和整体都加括号
3. 简单替换用宏，复杂逻辑用inline函数
4. 避免副作用（如a++）

## 应用场景
定义常量；简单计算；代码生成；条件编译；调试信息；跨平台适配；位操作封装。

## 注意事项
- 必须加完整括号防止优先级问题
- 注意副作用（参数不要有++、--）
- 宏展开可能导致代码膨胀
- 调试困难，优先考虑const和inline

## 关联知识
与 [[预处理器]]、[[条件编译]]、[[const关键字]]、[[inline函数]] 相关。
