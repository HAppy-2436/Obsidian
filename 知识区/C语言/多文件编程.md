# 多文件编程

## 定义
将程序分割为多个源文件（.c）和头文件（.h），通过extern声明、头文件包含、分离编译和链接，实现代码模块化、提高可维护性和编译效率。

## 核心内容
**1. 基本结构**
```
project/
├── main.c       # 主程序
├── math_ops.c   # 实现文件
├── math_ops.h   # 头文件
└── utils.c      # 其他模块
    └── utils.h
```

**2. 头文件（.h）**
```c
// math_ops.h
#ifndef MATH_OPS_H  // 头文件保护
#define MATH_OPS_H

// 函数声明
int add(int a, int b);
int multiply(int a, int b);

// 外部变量声明
extern int global_counter;

// 宏定义
#define MAX_SIZE 100

// 结构体定义
typedef struct {
    int x;
    int y;
} Point;

#endif
```

**3. 实现文件（.c）**
```c
// math_ops.c
#include "math_ops.h"

// 全局变量定义
int global_counter = 0;

// 函数实现
int add(int a, int b) {
    return a + b;
}

int multiply(int a, int b) {
    return a * b;
}

// 静态函数（仅本文件可见）
static int helper_func() {
    return 42;
}
```

**4. 主文件使用**
```c
// main.c
#include <stdio.h>
#include "math_ops.h"

int main() {
    int result = add(5, 3);
    printf("Result: %d\n", result);
    
    global_counter++;  // 访问其他文件的全局变量
    return 0;
}
```

**5. extern关键字**
```c
// file1.c
int shared_var = 100;  // 定义

// file2.c
extern int shared_var;  // 声明（告诉编译器变量在别处定义）
void func() {
    printf("%d\n", shared_var);
}
```

**6. static关键字（文件作用域）**
```c
// utils.c
static int private_var = 10;  // 仅本文件可见

static void private_func() {  // 仅本文件可见
    // ...
}
```

**7. 编译链接过程**
```bash
# 分别编译（生成目标文件.o）
gcc -c main.c -o main.o
gcc -c math_ops.c -o math_ops.o
gcc -c utils.c -o utils.o

# 链接（生成可执行文件）
gcc main.o math_ops.o utils.o -o program

# 或一步完成
gcc main.c math_ops.c utils.c -o program
```

**8. Makefile示例**
```makefile
CC = gcc
CFLAGS = -Wall -g

OBJS = main.o math_ops.o utils.o

program: $(OBJS)
	$(CC) $(OBJS) -o program

main.o: main.c math_ops.h
	$(CC) $(CFLAGS) -c main.c

math_ops.o: math_ops.c math_ops.h
	$(CC) $(CFLAGS) -c math_ops.c

utils.o: utils.c utils.h
	$(CC) $(CFLAGS) -c utils.c

clean:
	rm -f *.o program
```

**9. 头文件包含规则**
```c
#include <stdio.h>    // 系统头文件：<>
#include "myheader.h" // 自定义头文件：""

// 避免在头文件中包含.c文件
// 避免循环包含（A.h包含B.h，B.h包含A.h）
```

## 应用场景
- 大型项目：按功能模块分文件
- 团队协作：多人分别开发不同模块
- 代码复用：将通用函数封装成库
- 编译优化：只重新编译修改的文件
- 接口隔离：头文件定义接口，实现隐藏

## 注意事项
- 头文件必须有防护（#ifndef...#endif或#pragma once）
- 头文件中只放声明，不放定义（除inline、static、宏）
- 全局变量在一个文件定义，其他文件用extern声明
- 避免头文件相互包含（前向声明或调整结构）
- .c文件不要互相include
- 注意链接错误（undefined reference）

## 关联知识
与 [[预处理器]]、[[静态变量]]、[[const关键字]]、[[函数指针]] 相关。
