# 共用体

## 定义
共用体（union）是一种特殊的数据类型，允许在同一块内存中存储不同类型的数据，但任何时刻只能存储其中一个成员。大小为最大成员的大小。

## 核心内容
**1. 基本语法**
```c
union Data {
    int i;
    float f;
    char str[20];
};

union Data data;
data.i = 10;     // 存储整数
data.f = 3.14;   // 覆盖整数，现在存储浮点数
```

**2. 大小计算**
```c
union Test {
    char c;    // 1字节
    int i;     // 4字节
    double d;  // 8字节
};
sizeof(union Test) = 8; // 最大成员的大小（可能有对齐）
```

**3. union vs struct**
```c
struct S {
    int i;
    float f;
    char c;
}; // sizeof(S) = 12 (考虑对齐)

union U {
    int i;
    float f;
    char c;
}; // sizeof(U) = 4 (最大成员)
```

**4. 字节序判断**
```c
int check_endian() {
    union {
        int i;
        char c[4];
    } test;
    test.i = 1;
    return test.c[0] == 1; // 小端返回1，大端返回0
}
```

**5. 类型转换应用**
```c
// 浮点数的位表示
union FloatBits {
    float f;
    unsigned int bits;
};

FloatBits fb;
fb.f = 3.14f;
printf("Float bits: 0x%x\n", fb.bits); // 查看浮点数内部表示
```

**6. 变体类型（Tagged Union）**
```c
struct Variant {
    enum { INT, FLOAT, STRING } type; // 标签
    union {
        int i;
        float f;
        char *str;
    } data;
};

void print_variant(struct Variant v) {
    switch (v.type) {
        case INT: printf("%d\n", v.data.i); break;
        case FLOAT: printf("%f\n", v.data.f); break;
        case STRING: printf("%s\n", v.data.str); break;
    }
}
```

**7. 位域结合**
```c
union Register {
    unsigned int value;  // 整体访问
    struct {             // 位访问
        unsigned int bit0 : 1;
        unsigned int bit1 : 1;
        unsigned int reserved : 30;
    } bits;
};
```

## 应用场景
- 节省内存：互斥的数据成员共享空间
- 类型转换：查看数据的不同表示形式
- 硬件寄存器：整体读写或位域访问
- 变体类型：存储多种可能类型的数据
- 协议解析：网络包的不同视图

## 注意事项
- 只能初始化第一个成员（C99前）
- 不知道当前存储的是哪个成员容易出错（需标签）
- 成员间类型转换可能不安全
- 不要同时使用多个成员（未定义行为）
- 注意字节对齐

## 关联知识
与 [[结构体]]、[[内存布局]]、[[位运算]]、[[枚举类型]] 相关。
