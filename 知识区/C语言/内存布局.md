# 内存布局

## 定义
程序在内存中的组织结构，通常分为代码段、数据段、BSS段、堆、栈五个主要区域，各区域存储不同类型的数据，具有不同的生命周期和访问权限。

## 核心内容
**1. 内存分区图**
```
高地址
┌─────────────────┐
│   命令行参数    │ <- main(argc, argv)
│   环境变量      │
├─────────────────┤
│   栈 (Stack)    │ ↓ 向下增长
│                 │   局部变量、函数参数
├─────────────────┤
│        ↓        │
│     (空闲)      │
│        ↑        │
├─────────────────┤
│   堆 (Heap)     │ ↑ 向上增长
│                 │   malloc分配的内存
├─────────────────┤
│ BSS段(未初始化) │   未初始化全局/静态变量
├─────────────────┤
│ 数据段(已初始化)│   已初始化全局/静态变量
├─────────────────┤
│ 代码段 (Text)   │   可执行指令（只读）
└─────────────────┘
低地址
```

**2. 各区域详解**

**代码段（Text Segment）**
- 存储：可执行代码（机器指令）
- 属性：只读、共享（多进程可共享同一程序）
- 大小：编译时确定

**数据段（Data Segment）**
```c
int global_init = 10;      // 数据段
static int static_init = 5; // 数据段
```

**BSS段（Block Started by Symbol）**
```c
int global_uninit;         // BSS段
static int static_uninit;  // BSS段
```
特点：程序启动时自动清零

**堆（Heap）**
```c
int *p = (int *)malloc(sizeof(int) * 100); // 堆区
```
- 方向：向上增长
- 管理：程序员手动malloc/free
- 大小：运行时动态变化

**栈（Stack）**
```c
void func() {
    int local = 10;  // 栈区
    char arr[100];   // 栈区
}
```
- 方向：向下增长
- 管理：自动分配/释放
- 大小：受限（通常几MB）

**3. 实例分析**
```c
int g1 = 1;           // 数据段
int g2;               // BSS段
static int s1 = 2;    // 数据段
static int s2;        // BSS段
const int c = 3;      // 代码段（只读数据）

void func() {
    int local = 4;        // 栈
    static int s3 = 5;    // 数据段
    char *str = "hello";  // str在栈，"hello"在代码段
    char *p = malloc(10); // p在栈，分配的10字节在堆
}
```

## 应用场景
- 内存优化：合理选择存储位置
- 调试：理解段错误（访问非法内存）
- 嵌入式：ROM/RAM分配（const变量放ROM）
- 性能优化：栈快于堆

## 注意事项
- 栈溢出：大数组或深递归会导致栈溢出
- 内存泄漏：堆内存未释放会累积
- 野指针：访问已释放的堆内存
- 数据段常量：字符串字面量不可修改
- 不同系统布局可能略有差异

## 关联知识
与 [[指针]]、[[动态内存分配]]、[[静态变量]]、[[const关键字]] 相关。
