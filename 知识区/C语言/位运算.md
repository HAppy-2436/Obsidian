# 位运算

## 定义
位运算是直接对整数在内存中的二进制位进行操作的运算，包括按位与（&）、按位或（|）、按位异或（^）、按位取反（~）、左移（<<）、右移（>>）六种。位运算效率极高，常用于标志位管理、权限控制、底层优化、嵌入式编程。是数字电路[[逻辑代数]]在编程中的应用，也是算法优化的重要技巧。

## 核心内容
**六种位运算**：
```c
int a = 5;  // 0101
int b = 3;  // 0011

// 1. 按位与 &（都1才1）
a & b;  // 0001 = 1

// 2. 按位或 |（有1就1）
a | b;  // 0111 = 7

// 3. 按位异或 ^（不同为1）
a ^ b;  // 0110 = 6

// 4. 按位取反 ~（0变1,1变0）
~a;  // 1010（补码表示负数）

// 5. 左移 <<（乘以2^n）
a << 1;  // 1010 = 10（相当于×2）
a << 2;  // 10100 = 20（相当于×4）

// 6. 右移 >>（除以2^n）
a >> 1;  // 0010 = 2（相当于÷2）
```

**常用技巧**：
```c
// 1. 判断奇偶
if (n & 1) {  // 奇数
    // 最低位为1
}

// 2. 交换两数（不用临时变量）
a ^= b;
b ^= a;
a ^= b;

// 3. 取绝对值（对于负数）
int abs(int n) {
    int mask = n >> 31;  // 负数为-1，正数为0
    return (n + mask) ^ mask;
}

// 4. 判断2的幂
bool isPowerOf2(int n) {
    return n > 0 && (n & (n - 1)) == 0;
}

// 5. 计算二进制中1的个数
int countOnes(int n) {
    int count = 0;
    while (n) {
        count++;
        n &= (n - 1);  // 清除最右边的1
    }
    return count;
}

// 6. 获取最右边的1
int rightmostOne(int n) {
    return n & (-n);
}

// 7. 清除最右边的1
int clearRightmost(int n) {
    return n & (n - 1);
}
```

**位掩码（Bitmask）**：
```c
// 定义标志位
#define FLAG_A 0x01  // 0001
#define FLAG_B 0x02  // 0010
#define FLAG_C 0x04  // 0100
#define FLAG_D 0x08  // 1000

int flags = 0;

// 设置标志
flags |= FLAG_A;  // 打开FLAG_A
flags |= FLAG_C;  // 打开FLAG_C

// 清除标志
flags &= ~FLAG_A;  // 关闭FLAG_A

// 切换标志
flags ^= FLAG_B;  // 翻转FLAG_B

// 检查标志
if (flags & FLAG_C) {  // FLAG_C是否打开
    // ...
}
```

**位字段操作**：
```c
// 提取某几位
#define GET_BITS(n, pos, len) (((n) >> (pos)) & ((1 << (len)) - 1))

// 设置某几位
#define SET_BITS(n, pos, len, val) \
    ((n) = ((n) & ~(((1 << (len)) - 1) << (pos))) | ((val) << (pos)))
```

**移位优化乘除**：
```c
// 乘法
n * 2   →  n << 1
n * 4   →  n << 2
n * 8   →  n << 3

// 除法（正数）
n / 2   →  n >> 1
n / 4   →  n >> 2
n / 8   →  n >> 3
```

**异或特性**：
```c
// a ^ a = 0
// a ^ 0 = a
// a ^ b ^ b = a（消除成对元素）

// 应用：找出数组中唯一出现一次的数
int findSingle(int arr[], int n) {
    int result = 0;
    for (int i = 0; i < n; i++) {
        result ^= arr[i];  // 成对的会消除
    }
    return result;
}
```

## 应用场景
标志位管理；权限控制；集合操作；加密算法；图像处理；网络编程（IP地址、子网掩码）；嵌入式寄存器操作。

## 注意事项
- 优先级：移位 > 关系运算 > 位运算，注意加括号
- 右移负数是算术右移（填充符号位）
- 移位超过位数是未定义行为
- &和&&、|和||不要混淆

## 关联知识
与 [[逻辑代数]]、[[数制和码制]]、[[宏定义]]、[[位字段]]、[[嵌入式编程]] 相关。
